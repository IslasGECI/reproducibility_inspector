---
- hosts: reproducibility_inspector
  tasks:
    - name: Configura huso horario
      timezone:
        name: America/Los_Angeles
      become: yes
    - name: Actualiza paquetes del sistema operativo
      apt:
        upgrade: dist
        update_cache: yes
      become: yes
      notify: Reinicia servidor
    - name: Instala Docker
      apt:
        name: "docker.io"
        state: present
      become: yes
    - name: Instala Git
      apt:
        name: "git"
        state: present
      become: yes
    - name: Instala Make
      apt:
        name: "make"
        state: present
      become: yes
    - name: Instala pip
      apt:
        name: "python3-pip"
        state: present
      become: yes
    - name: Instala Docker SDK para Python
      pip:
        name: docker
      notify: Reinicia servidor
    - name: Agrega '{{ ansible_user_id }}' al grupo docker
      user:
        name: "{{ ansible_user_id }}"
        groups: docker
        append: yes
      become: yes
      notify: Reinicia servidor
    - name: Copia credenciales
      copy:
        src: ~/.vault
        dest: "{{ ansible_facts.user_dir }}"
    - name: Crea directorio para guardar logs
      file:
        path: "{{ ansible_facts.user_dir }}/var/log"
        state: directory
        recurse: yes
    - name: Crea directorio para correr geci-testmake
      file:
        path: "{{ ansible_facts.user_dir }}/.testmake"
        state: directory
        recurse: yes
    - name: Jala la imagen islasgeci/reproducibility_inspector
      docker_image:
        name: islasgeci/reproducibility_inspector:latest
        source: pull
  handlers:
    - name: Reinicia servidor
      reboot:
      become: yes

- hosts: reproducibility_inspector
  tasks:
    - name: Inicia contenedor reproducibility_inspector
      docker_container:
        name: reproducibility_inspector
        image: "islasgeci/reproducibility_inspector:latest"
        state: started
        restart_policy: always
        volumes:
          - "{{ ansible_facts.user_dir }}/.testmake:/home/ciencia_datos/.testmake"
          - "{{ ansible_facts.user_dir }}/.vault:/.vault"
          - "/var/run/docker.sock:/var/run/docker.sock"
          - "reproducibility_inspector_vol:/workdir"
